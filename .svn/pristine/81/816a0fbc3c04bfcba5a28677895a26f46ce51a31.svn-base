package si.um.feri.praktikum;

import java.io.File;
import java.io.IOException;
import java.io.PrintWriter;
import java.net.URL;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.util.ArrayList;
import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import org.w3c.dom.Document;

@WebServlet(urlPatterns="/IzvoziVXML")
public class IzvoziVXML extends HttpServlet {
	private static final long serialVersionUID = 1L;
       
    public IzvoziVXML() {
        super();
    }

	protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		try {
			int bazniIDfilma = Integer.parseInt(request.getParameter("idFilma"));
			Movie filmZaIzvoz = new MovieDao().selectMovie(bazniIDfilma);
			Class.forName("com.mysql.jdbc.Driver");
			Connection con = DriverManager.getConnection("jdbc:mysql://svizec2.informatika.uni-mb.si:3306/s4p3_kino?autoReconnect=true&useSSL=false", "s4p3_kino", "v345qc");
			PreparedStatement predstaveFilmaStavek = con.prepareStatement("select shows_id from shows where movies_movie_id = ?");
			predstaveFilmaStavek.setInt(1, bazniIDfilma);
			
			ResultSet predstaveFilma = predstaveFilmaStavek.executeQuery();
			ArrayList<Show> predstave = new ArrayList<Show>();
			while (predstaveFilma.next()) {
				predstave.add(new ShowDao().selectShow2(predstaveFilma.getInt(1)));
			}

			response.setCharacterEncoding("UTF-8");
			
			PrintWriter out = response.getWriter();
			StringBuffer sb = new StringBuffer();
			sb.append("<?xml version=\"1.0\" encoding=\"utf-8\"?>\n");
			sb.append("<movie id=\"" + filmZaIzvoz.getKolosejevID() + "\">");
				sb.append("<movies_id>" + filmZaIzvoz.getBazniID() + "</movies_id>\n");
				sb.append("<title>" + filmZaIzvoz.getTitle() + "</title>\n");
				sb.append("<original_title>" + filmZaIzvoz.getOriginalTitle() + "</original_title>\n");
				sb.append("<punchline>" + filmZaIzvoz.getPunchline() + "</punchline>\n");
				sb.append("<trailer>" + filmZaIzvoz.getTrailer() + "</trailer>\n");
				sb.append("<genre>" + filmZaIzvoz.getGenre() + "</genre>\n");
				sb.append("<year>" + filmZaIzvoz.getYear() + "</year>\n");
				sb.append("<duration>" + filmZaIzvoz.getDuration() + "</duration>\n");
				sb.append("<url>" + filmZaIzvoz.getUrl() + "</url>\n");
				sb.append("<poster>" + filmZaIzvoz.getPoster() + "</poster>\n");
				sb.append("<director>" + filmZaIzvoz.getDirector() + "</director>\n");
				sb.append("<producer>" + filmZaIzvoz.getProducer() + "</producer>\n");
				sb.append("<writer>" + filmZaIzvoz.getWriter() + "</writer>\n");
				sb.append("<cast>" + filmZaIzvoz.getCast() + "</cast>\n");
				sb.append("<distributor>" + filmZaIzvoz.getDistributor() + "</distributor>\n");
				sb.append("<language>" + filmZaIzvoz.getLanguage() + "</language>\n");
				sb.append("<country>" + filmZaIzvoz.getCountry() + "</country>\n");
				sb.append("<localization>" + filmZaIzvoz.getLocalization() + "</localization>\n");
				sb.append("<plot_outline>" + filmZaIzvoz.getPlotOutline() + "</plot_outline>\n");
				sb.append("<sum_of_scores>" + filmZaIzvoz.getSumOfScores() + "</sum_of_scores>\n");
				sb.append("<num_of_scores>" + filmZaIzvoz.getNumOfScores() + "</num_of_scores>\n");
				sb.append("<na_voljo>" + filmZaIzvoz.isNa_voljo() + "</na_voljo>\n");
				sb.append("<shows>\n");
					for(Show s : predstave) {
						sb.append("<show id=\"" + s.getShowsID() + "\">");
							sb.append("<shows_id>" + s.getShowID() + "</shows_id>\n");
							sb.append("<date>" + s.getDate() + "</date>\n");
							sb.append("<time>" + s.getTime() + "</time>\n");
							sb.append("<city>" + s.getCity() + "</city>\n");
							sb.append("<center>" + s.getCenter() + "</center>\n");
							sb.append("<theater>" + s.getTheater() + "</theater>\n");
						sb.append("</show>\n");
					}
				sb.append("</shows>\n");
			sb.append("</movie>");
			out.println(sb.toString());
			out.flush();
						
			System.out.println("Podatki so izvo≈æeni v XML!");

		} catch (Exception e) {
			e.printStackTrace();
		}
	}
}